<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>LoCAR Example â€” Readable Imports</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script type="module">
    // modulepreload polyfill (same as original)
    import "https://ar-js-org.github.io/locar.js/assets/modulepreload-polyfill-B5Qt9EMX.js";

    // map minified exports to readable names using `as`
    import {
      P as PerspectiveCamera,
      W as WebGLRenderer,
      S as Scene,
      k as GpsEntityManager,
      b as CameraFeed,
      V as SensorController,
      B as BoxGeometry,
      M as Mesh,
      a as MeshBasicMaterial,
    } from "https://ar-js-org.github.io/locar.js/assets/locar.es-8YGvHcXJ.js";

    // ---- Equivalent logic from the original example, using readable names ----

    const camera = new PerspectiveCamera(
      80,
      window.innerWidth / window.innerHeight,
      0.001,
      1e3
    );

    const renderer = new WebGLRenderer({ canvas: document.getElementById("glscene") });
    renderer.setSize(window.innerWidth, window.innerHeight);

    const scene = new Scene();
    const gpsManager = new GpsEntityManager(scene, camera);
    const cameraFeed = new CameraFeed({ video: { facingMode: "environment" } }, null);

    cameraFeed.on("webcamstarted", (e) => {
      scene.background = e.texture;
    });
    cameraFeed.on("webcamerror", (e) => {
      alert(`Webcam error: code ${e.code} message ${e.message}`);
    });

    window.addEventListener("resize", () => {
      renderer.setSize(window.innerWidth, window.innerHeight);
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
    });

    let firstFix = true;
    const sensorController = new SensorController(camera);

    sensorController.on("deviceorientationgranted", (e) => {
      e.target.connect();
    });
    sensorController.on("deviceorientationerror", (e) => {
      alert(`Device orientation error: code ${e.code} message ${e.message}`);
    });
    sensorController.init();

    gpsManager.on("gpserror", (e) => {
      alert(`GPS error: ${e.code}`);
    });

    gpsManager.on("gpsupdate", (e) => {
      if (firstFix) {
        alert(
          `Got the initial location: longitude ${e.position.coords.longitude}, latitude ${e.position.coords.latitude}`
        );

        const positions = [
          { latDis: 5e-4, lonDis: 0, colour: 16711680 },   // red - north
          { latDis: -5e-4, lonDis: 0, colour: 16776960 },  // yellow - south
          { latDis: 0, lonDis: -5e-4, colour: 65535 },     // blue - west
          { latDis: 0, lonDis: 5e-4, colour: 65280 },      // green - east
        ];

        const boxGeometry = new BoxGeometry(10, 10, 10);
        for (const p of positions) {
          const mesh = new Mesh(boxGeometry, new MeshBasicMaterial({ color: p.colour }));
          gpsManager.add(
            mesh,
            e.position.coords.longitude + p.lonDis,
            e.position.coords.latitude + p.latDis
          );
        }
        firstFix = false;
      }
    });

    gpsManager.startGps();

    document.getElementById("setFakeLoc").addEventListener("click", () => {
      alert("Using fake input GPS, not real GPS location");
      gpsManager.stopGps();
      gpsManager.fakeGps(
        parseFloat(document.getElementById("fakeLon").value),
        parseFloat(document.getElementById("fakeLat").value)
      );
    });

    renderer.setAnimationLoop(renderFrame);
    function renderFrame() {
      sensorController?.update();
      renderer.render(scene, camera);
    }
  </script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
      font-family: sans-serif;
    }

    #gpsinput {
      position: absolute;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 999;
      text-align: center;
    }

    input {
      margin: 4px;
      padding: 0.4rem;
      width: 150px;
    }

    button {
      background: rgba(255, 255, 255, 0.9);
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }

    button:hover {
      background: #ddd;
    }

    canvas {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <main>
    <div id="gpsinput">
      <div><input id="fakeLat" placeholder="Fake Lat" /></div>
      <div><input id="fakeLon" placeholder="Fake Lon" /></div>
      <div><button id="setFakeLoc">Set Fake Location!</button></div>
    </div>

    <canvas id="glscene"></canvas>
  </main>
</body>

</html>
